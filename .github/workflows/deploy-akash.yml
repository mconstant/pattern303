name: Deploy to Akash Network

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'Deployment action'
        required: true
        default: 'update'
        type: choice
        options:
          - deploy
          - update
          - close

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Determine which environment to use based on trigger
  set-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      solana_network: ${{ steps.set-env.outputs.solana_network }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          # workflow_dispatch uses the input directly
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
          # push to main = prod
          elif [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="prod"
          # push to dev or PR to main = dev
          else
            ENV="dev"
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT

          # Set Solana network based on environment
          if [ "$ENV" == "prod" ]; then
            echo "solana_network=mainnet-beta" >> $GITHUB_OUTPUT
          else
            echo "solana_network=devnet" >> $GITHUB_OUTPUT
          fi

          echo "Selected environment: $ENV"

  build-and-push:
    needs: set-environment
    runs-on: ubuntu-latest
    environment: ${{ needs.set-environment.outputs.environment }}
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ needs.set-environment.outputs.environment }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=dev-latest,enable=${{ github.ref == 'refs/heads/dev' }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VITE_TREASURY_WALLET=${{ secrets.VITE_TREASURY_WALLET }}
            VITE_303_TOKEN_MINT=${{ secrets.VITE_303_TOKEN_MINT }}
            VITE_COLLECTION_ADDRESS=${{ secrets.VITE_COLLECTION_ADDRESS }}
            VITE_SOLANA_NETWORK=${{ needs.set-environment.outputs.solana_network }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-akash:
    needs: [set-environment, build-and-push]
    runs-on: ubuntu-latest
    environment: ${{ needs.set-environment.outputs.environment }}
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Display deployment info
        run: |
          echo "Environment: ${{ needs.set-environment.outputs.environment }}"
          echo "Solana Network: ${{ needs.set-environment.outputs.solana_network }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"

      - name: Install Akash provider-services CLI
        run: |
          curl -sfL https://raw.githubusercontent.com/akash-network/provider/main/install.sh | bash
          sudo mv ./bin/provider-services /usr/local/bin
          provider-services version

      - name: Setup Akash wallet
        env:
          AKASH_KEYRING_BACKEND: file
        run: |
          # Create keyring directory structure
          mkdir -p ~/.akash/keyring-file
          # Decode and extract the keyring tar archive
          echo "${{ secrets.AKASH_WALLET_KEY }}" | base64 -d | tar -xzf - -C ~/.akash/keyring-file
          # Set proper permissions
          chmod 0700 ~/.akash/keyring-file
          chmod 0600 ~/.akash/keyring-file/* 2>/dev/null || true
          # Verify keyring setup
          echo "=== Keyring files extracted ==="
          ls -la ~/.akash/keyring-file/

          # Find key name
          KEY_NAME=$(ls ~/.akash/keyring-file/*.info 2>/dev/null | head -1 | xargs basename 2>/dev/null | sed 's/.info$//' || echo "my-akash-account")
          echo "Found key name: $KEY_NAME"
          echo "KEY_NAME=$KEY_NAME" >> $GITHUB_ENV

      - name: Prepare SDL file
        env:
          GITHUB_USERNAME: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
          GITHUB_ENVIRONMENT: ${{ needs.set-environment.outputs.environment }}
        run: |
          # Use short SHA (7 chars) to match Docker tag
          export IMAGE_TAG=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "Using image tag: $IMAGE_TAG"
          # Substitute environment variables in deploy.yaml
          envsubst < deploy.yaml > deploy-final.yaml
          cat deploy-final.yaml

      - name: Setup certificates
        env:
          AKASH_NODE: ${{ secrets.AKASH_NODE }}
          AKASH_CHAIN_ID: ${{ secrets.AKASH_CHAIN_ID }}
          AKASH_KEYRING_BACKEND: file
          AKASH_FROM: ${{ secrets.AKASH_ACCOUNT_ADDRESS }}
          AKASH_KEY_PASSWORD: ${{ secrets.AKASH_KEY_PASSWORD }}
          AKASH_GAS: auto
          AKASH_GAS_ADJUSTMENT: 1.5
          AKASH_GAS_PRICES: 0.025uakt
        run: |
          # Check balance (no password needed for queries)
          echo "Checking account balance..."
          provider-services query bank balances --node $AKASH_NODE $AKASH_FROM

          # Generate and publish certificate
          echo "Generating client certificate..."
          # Create a temporary password file with multiple lines (in case it prompts multiple times)
          for i in {1..10}; do echo "$AKASH_KEY_PASSWORD"; done > /tmp/akash_pass.txt

          # Use the password file with input redirection
          provider-services tx cert generate client \
            --from "$KEY_NAME" \
            --overwrite \
            -y < /tmp/akash_pass.txt

          echo "Publishing certificate to blockchain..."
          provider-services tx cert publish client \
            --from "$KEY_NAME" \
            -y < /tmp/akash_pass.txt

          # Clean up password file
          rm -f /tmp/akash_pass.txt

          sleep 5
          echo "Certificate created and published"

      - name: Deploy to Akash
        if: github.event.inputs.action != 'close'
        env:
          AKASH_NODE: ${{ secrets.AKASH_NODE }}
          AKASH_CHAIN_ID: ${{ secrets.AKASH_CHAIN_ID }}
          AKASH_KEYRING_BACKEND: file
          AKASH_FROM: ${{ secrets.AKASH_ACCOUNT_ADDRESS }}
          AKASH_KEY_PASSWORD: ${{ secrets.AKASH_KEY_PASSWORD }}
          AKASH_GAS: auto
          AKASH_GAS_ADJUSTMENT: 1.5
          AKASH_GAS_PRICES: 0.025uakt
          AKASH_SIGN_MODE: amino-json
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          PREFERRED_PROVIDERS: "akash18ga02jzaq8cw52anyhzkwta5wygufgu6zsz6xc,akash15ksejj7g4su7ljufsg0a8eglvkje94z8qsh68a,akash175llqyjvxfle9qwt740vm46772dzaznpzgm576"
        run: |
          DSEQ="${{ secrets.AKASH_DEPLOYMENT_DSEQ }}"
          ENV="${{ needs.set-environment.outputs.environment }}"

          # Create password file for all operations (multiple lines in case of multiple prompts)
          for i in {1..10}; do echo "$AKASH_KEY_PASSWORD"; done > /tmp/akash_pass.txt

          # Update existing deployment if DSEQ is set, otherwise create new
          if [ -n "$DSEQ" ]; then
            echo "Updating existing $ENV deployment $DSEQ..."
            provider-services tx deployment update deploy-final.yaml \
              --dseq $DSEQ \
              --from "$KEY_NAME" \
              -y < /tmp/akash_pass.txt

            # Send updated manifest
            echo "Sending updated manifest..."
            PROVIDER=$(provider-services query market lease list --owner $AKASH_FROM --dseq $DSEQ -o json | jq -r '.leases[0].lease.lease.id.provider // .leases[0].lease.id.provider')
            provider-services send-manifest deploy-final.yaml \
              --dseq $DSEQ \
              --provider $PROVIDER \
              --from "$KEY_NAME" < /tmp/akash_pass.txt
            echo "Deployment $DSEQ updated"
          else
            echo "Creating new $ENV deployment..."
            provider-services tx deployment create deploy-final.yaml \
              --from "$KEY_NAME" \
              -y < /tmp/akash_pass.txt

            # Wait for deployment to be indexed
            echo "Waiting for deployment to be indexed..."
            sleep 15

            # Extract DSEQ - try multiple possible JSON paths
            NEW_DSEQ=$(provider-services query deployment list --owner $AKASH_FROM --state active -o json | jq -r '.deployments[-1].deployment.deployment.id.dseq // .deployments[-1].deployment.id.dseq // empty')

            # If still empty, try without state filter
            if [ -z "$NEW_DSEQ" ] || [ "$NEW_DSEQ" = "null" ]; then
              NEW_DSEQ=$(provider-services query deployment list --owner $AKASH_FROM -o json | jq -r '.deployments[-1].deployment.deployment.id.dseq // .deployments[-1].deployment.id.dseq // empty')
            fi

            echo "New DSEQ: $NEW_DSEQ"

            if [ -z "$NEW_DSEQ" ] || [ "$NEW_DSEQ" = "null" ]; then
              echo "::error::Failed to find deployment DSEQ"
              exit 1
            fi

            # Save DSEQ to secrets for env
            if gh secret set AKASH_DEPLOYMENT_DSEQ --body "$NEW_DSEQ" --env "$ENV" 2>/dev/null; then
              echo "DSEQ saved to $ENV environment secrets"
            else
              echo "::warning::Could not auto-save DSEQ. Please add AKASH_DEPLOYMENT_DSEQ=$NEW_DSEQ as a secretto the $ENV environment"
            fi
            DSEQ="$NEW_DSEQ"

            # Wait for bids
            echo "Waiting for bids..."
            for i in {1..12}; do
              sleep 10
              BIDS=$(provider-services query market bid list --owner $AKASH_FROM --dseq $DSEQ -o json)
              BID_COUNT=$(echo "$BIDS" | jq '.bids | length')
              echo "Attempt $i: Found $BID_COUNT bids"
              if [ "$BID_COUNT" -gt 0 ]; then
                break
              fi
            done

            if [ "$BID_COUNT" -eq 0 ]; then
              echo "::error::No bids received"
              exit 1
            fi

            # Select cheapest bid - handle different JSON structures
            SELECTED_BID=$(echo "$BIDS" | jq -r --arg providers "$PREFERRED_PROVIDERS" '
              .bids
              | map(select(.bid.state == "open" or .bid.bid.state == "open"))
              | map(select((.bid.bid.id.provider // .bid.id.provider) as $p | ($providers | split(",") | index($p))))
              | sort_by((.bid.price.amount // .bid.bid.price.amount) | tonumber)
              | first
            ')

            if [ -z "$SELECTED_BID" ] || [ "$SELECTED_BID" = "null" ]; then
              SELECTED_BID=$(echo "$BIDS" | jq -r '.bids | map(select(.bid.state == "open" or .bid.bid.state == "open")) | sort_by((.bid.price.amount // .bid.bid.price.amount) | tonumber) | first')
            fi

            PROVIDER=$(echo "$SELECTED_BID" | jq -r '.bid.bid.id.provider // .bid.id.provider')
            GSEQ=$(echo "$SELECTED_BID" | jq -r '.bid.bid.id.gseq // .bid.id.gseq')
            OSEQ=$(echo "$SELECTED_BID" | jq -r '.bid.bid.id.oseq // .bid.id.oseq')

            echo "Selected provider: $PROVIDER"

            # Create lease
            echo "Creating lease..."
            provider-services tx market lease create \
              --dseq $DSEQ \
              --provider $PROVIDER \
              --from "$KEY_NAME" \
              -y < /tmp/akash_pass.txt

            sleep 10

            # Send manifest
            echo "Sending manifest..."
            provider-services send-manifest deploy-final.yaml \
              --dseq $DSEQ \
              --provider $PROVIDER \
              --from "$KEY_NAME" < /tmp/akash_pass.txt

            # Get service status
            sleep 5
            SERVICE_STATUS=$(provider-services lease-status \
              --dseq $DSEQ \
              --provider $PROVIDER \
              --from "$KEY_NAME" < /tmp/akash_pass.txt 2>/dev/null || echo "{}")

            SERVICE_URL=$(echo "$SERVICE_STATUS" | jq -r '.services.web.uris[0] // empty')
            if [ -n "$SERVICE_URL" ]; then
              echo "::notice::Deployment live at: https://$SERVICE_URL"
            fi

            echo "Deployment complete! DSEQ: $DSEQ"
          fi

          # Clean up password file
          rm -f /tmp/akash_pass.txt

      - name: Close deployment
        if: github.event.inputs.action == 'close'
        env:
          AKASH_NODE: ${{ secrets.AKASH_NODE }}
          AKASH_CHAIN_ID: ${{ secrets.AKASH_CHAIN_ID }}
          AKASH_KEYRING_BACKEND: file
          AKASH_KEY_PASSWORD: ${{ secrets.AKASH_KEY_PASSWORD }}
          AKASH_GAS: auto
          AKASH_GAS_ADJUSTMENT: 1.5
          AKASH_GAS_PRICES: 0.025uakt
          AKASH_SIGN_MODE: amino-json
        run: |
          for i in {1..10}; do echo "$AKASH_KEY_PASSWORD"; done > /tmp/akash_pass.txt

          DSEQ="${{ secrets.AKASH_DEPLOYMENT_DSEQ }}"
          if [ -n "$DSEQ" ]; then
            echo "Closing deployment $DSEQ..."
            provider-services tx deployment close \
              --dseq $DSEQ \
              --from "$KEY_NAME" \
              -y < /tmp/akash_pass.txt
            echo "Deployment closed"
          else
            echo "No DSEQ provided, nothing to close"
          fi

          rm -f /tmp/akash_pass.txt

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ needs.set-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Solana Network:** ${{ needs.set-environment.outputs.solana_network }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$(echo ${{ github.sha }} | cut -c1-7)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Action:** ${{ github.event.inputs.action || 'update' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Secrets Used" >> $GITHUB_STEP_SUMMARY
          echo "Secrets are scoped to the **${{ needs.set-environment.outputs.environment }}** environment." >> $GITHUB_STEP_SUMMARY
